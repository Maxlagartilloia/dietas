<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DietaryTrack | Dashboard de Dieta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Librería para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .details-content.open {
            max-height: 1000px;
        }
        /* Estilos para el contenido de la receta generada */
        .prose h3 {
            font-weight: 800;
            font-size: 1.25rem;
            color: #059669;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom-width: 2px;
            border-color: #a7f3d0;
        }
        .prose h4 {
            font-weight: 600;
            font-size: 1.125rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .prose p {
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
        }
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        .prose li {
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Modals -->
    <div id="goal-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl transform transition-all overflow-y-auto max-h-screen">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Define Tus Metas</h2>
                <button id="close-goal-modal-btn" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-7 h-7"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div><label class="block text-sm font-semibold text-gray-600 mb-1">Género</label><select id="gender-input" name="gender" class="w-full p-2.5 border border-gray-300 rounded-lg"><option value="">Seleccionar...</option><option value="male">Masculino</option><option value="female">Femenino</option></select></div>
                <div><label class="block text-sm font-semibold text-gray-600 mb-1">Edad</label><input type="number" id="age-input" name="age" placeholder="ej. 30" class="w-full p-2.5 border border-gray-300 rounded-lg" /></div>
                <div><label class="block text-sm font-semibold text-gray-600 mb-1">Peso (kg)</label><input type="number" id="weight-input" name="weight" placeholder="ej. 70" class="w-full p-2.5 border border-gray-300 rounded-lg" /></div>
                <div><label class="block text-sm font-semibold text-gray-600 mb-1">Estatura (cm)</label><input type="number" id="height-input" name="height" placeholder="ej. 175" class="w-full p-2.5 border border-gray-300 rounded-lg" /></div>
                <div class="md:col-span-2"><label class="block text-sm font-semibold text-gray-600 mb-1">Nivel de Actividad</label><select id="activity-level-input" name="activityLevel" class="w-full p-2.5 border border-gray-300 rounded-lg"><option value="">Seleccionar...</option><option value="1.2">Sedentario</option><option value="1.375">Ligero (1-3 días/sem)</option><option value="1.55">Moderado (3-5 días/sem)</option><option value="1.725">Fuerte (6-7 días/sem)</option><option value="1.9">Muy Fuerte (2x día)</option></select></div>
            </div>
            <div class="flex justify-center mb-6"><button id="calculate-goals-btn" class="bg-emerald-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-emerald-600 transition-colors text-lg">Calcular Mis Metas</button></div>
            <div id="modal-results-container" class="hidden">
                 <div class="bg-emerald-50 p-6 rounded-xl border border-emerald-200"><h3 class="text-xl font-bold text-emerald-800 mb-4 text-center">Tus Objetivos Diarios</h3><div id="modal-results-content" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"></div></div>
                <div class="mt-6 bg-gray-50 p-6 rounded-xl border border-gray-200"><h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Entiende tu Objetivo</h3><div id="modal-explanation-content" class="text-sm text-gray-700 space-y-3"></div></div>
                 <div class="mt-6 flex justify-center"><button id="save-goals-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors">Guardar y Usar Metas</button></div>
            </div>
        </div>
    </div>

    <div id="recipe-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-3xl transform transition-all overflow-y-auto max-h-screen">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Tu Recetario del Día</h2>
                <div class="flex items-center gap-4">
                    <button id="export-pdf-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold flex items-center"><i data-lucide="file-down" class="w-4 h-4 mr-2"></i>Exportar a PDF</button>
                    <button id="close-recipe-modal-btn" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-7 h-7"></i></button>
                </div>
            </div>
            <div id="recipe-content-container" class="prose max-w-none text-gray-700"></div>
        </div>
    </div>

    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-3xl transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Tu Progreso Semanal</h2>
                <button id="close-progress-modal-btn" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-7 h-7"></i></button>
            </div>
            <div>
                <canvas id="progress-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <header class="bg-white shadow-sm sticky top-0 z-10 border-b border-gray-200">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center">
                    <div class="bg-emerald-500 p-2 rounded-lg mr-3"><i data-lucide="zap" class="text-white w-6 h-6"></i></div>
                    <h1 class="text-2xl font-extrabold text-gray-800">Dietary<span class="text-emerald-500">Track</span></h1>
                </div>
                <div class="flex items-center bg-gray-100 p-1.5 rounded-xl">
                    <button id="prev-day-btn" class="p-2 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <div class="relative mx-2">
                        <i data-lucide="calendar" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none w-5 h-5"></i>
                        <input type="date" id="date-picker" class="bg-white border-2 border-gray-200 rounded-lg p-2 pl-10 w-40 text-left font-semibold text-gray-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
                    </div>
                    <button id="next-day-btn" class="p-2 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
                 <button id="progress-btn" class="p-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"><i data-lucide="bar-chart-3" class="w-5 h-5"></i></button>
                <div class="w-full md:w-auto lg:w-1/3 bg-gray-100 p-3 rounded-xl">
                    <div class="flex justify-between items-center mb-1 text-sm font-semibold">
                        <span class="text-emerald-600">Consumido</span>
                        <button id="open-modal-btn" class="flex items-center text-gray-500 hover:text-emerald-600 transition-colors">
                            <i data-lucide="target" class="w-4 h-4 mr-1"></i>
                            <span id="calorie-goal-text">Objetivo: 2000 kcal</span>
                        </button>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-emerald-500 h-2.5 rounded-full" style="width: 0%;"></div>
                    </div>
                    <p id="daily-total-calories" class="text-right font-bold text-gray-700 mt-1">0 kcal</p>
                </div>
            </div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto p-4 md:p-8">
        <div id="welcome-banner" class="mb-10 bg-emerald-500 text-white p-8 rounded-xl shadow-lg text-center hidden">
            <h2 class="text-3xl font-bold mb-2">¡Bienvenido a DietaryTrack!</h2>
            <p class="mb-6">Para empezar a transformar tu alimentación, primero necesitamos conocer tus metas.</p>
            <button id="welcome-define-goals-btn" class="bg-white text-emerald-600 font-bold py-3 px-6 rounded-lg hover:bg-emerald-50 transition-colors text-lg flex items-center mx-auto">
                <i data-lucide="target" class="w-6 h-6 mr-3"></i>Definir Mis Metas Ahora
            </button>
        </div>
        <div id="principles-container" class="mb-10 bg-white p-6 rounded-xl shadow-md border border-gray-100">
            <button id="toggle-principles-btn" class="w-full flex justify-between items-center text-left">
                <h2 class="text-2xl font-bold text-gray-800">Principios Clave para tu Éxito</h2>
                <i data-lucide="chevron-down" id="principles-arrow" class="w-6 h-6 transition-transform"></i>
            </button>
            <div id="principles-content" class="details-content mt-4 text-gray-600">
                <ul class="space-y-4">
                    <li class="flex items-start"><i data-lucide="shield-check" class="w-5 h-5 mr-3 text-emerald-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Equilibrio de Macronutrientes:</strong> Prioriza las proteínas (1.6-2.2 g/kg de peso) para construir músculo, carbohidratos complejos (quinua, morocho, yuca) para energía sostenida y grasas saludables (aguacate, nueces) para la función hormonal.</span></li>
                    <li class="flex items-start"><i data-lucide="droplets" class="w-5 h-5 mr-3 text-blue-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Hidratación Constante:</strong> Bebe al menos 2 litros de agua al día. Es vital para el rendimiento muscular y el metabolismo.</span></li>
                    <li class="flex items-start"><i data-lucide="bed-double" class="w-5 h-5 mr-3 text-indigo-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Descanso Reparador:</strong> Dormir 7-9 horas es crucial. El descanso optimiza las hormonas que regulan el hambre y favorecen el crecimiento muscular.</span></li>
                    <li class="flex items-start"><i data-lucide="dumbbell" class="w-5 h-5 mr-3 text-red-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Actividad Física Combinada:</strong> Acompaña tu dieta con ejercicios de fuerza (pesas, CrossFit) y cardio (caminar, trotar) para maximizar la quema de grasa y la ganancia de músculo.</span></li>
                    <li class="flex items-start"><i data-lucide="ban" class="w-5 h-5 mr-3 text-gray-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Evita lo que no te suma:</strong> Limita al máximo los azúcares añadidos, alimentos ultraprocesados, frituras y alcohol. Aportan calorías vacías y dificultan tus objetivos.</span></li>
                    <li class="flex items-start"><i data-lucide="stethoscope" class="w-5 h-5 mr-3 text-teal-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Consulta Profesional:</strong> Estas son guías excelentes, pero un nutricionista puede crear un plan perfectamente adaptado a ti.</span></li>
                </ul>
            </div>
        </div>
        <div id="meals-container"></div>
        <div id="recipe-button-container" class="mt-10 flex justify-center"></div>
    </main>

    <footer class="text-center py-8 px-4">
        <div class="bg-white p-6 rounded-xl max-w-2xl mx-auto shadow-lg border border-gray-100">
            <p id="quote-text" class="text-gray-500 italic text-lg"></p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            let state = {
                dietLog: {},
                userProfile: { profileComplete: false, weight: '', height: '', age: '', gender: '', activityLevel: '' },
                calorieGoal: 2000,
                selectedDate: formatDate(new Date()),
            };
            let progressChart = null;
            
            const calorieDatabase = {
                'aguacate': 160, 'nueces': 654, 'maní': 567, 'semillas de sambo': 559, 'nata de leche': 350,
                'huevo criollo': 155, 'quesito de hoja': 280, 'leche de finca': 60, 'yogur de pajarito': 70,
                'bolón de verde asado': 250, 'majado de verde': 180, 'avena': 389, 'frutas de temporada': 70, 'jugo de naranjilla': 40,
                'aceite de achiote': 900, 'aceite de oliva': 884,
                'pechuga de pollo': 239, 'menestra de lenteja': 116, 'trucha al ajillo': 190, 'menestra de fréjol': 130, 'corvina': 95, 'carne en bistec': 250,
                'arroz integral': 111, 'patacones al horno': 150, 'ensalada criolla': 50, 'morocho partido': 110, 'yuca al vapor': 160, 'maduro asado': 150, 'mote pillo': 120,
                'caldo de gallina': 250, 'humita de sal': 180, 'chochos con tostado': 150, 'pescado encocado': 300,
                'ensalada de vegetales': 40, 'calabacín salteado': 30, 'brócoli al vapor': 34, 'sopa de quinua': 150, 'mellocos salteados': 70
            };
            
            const motivationalQuotes = [
                "La disciplina es el puente entre las metas y los logros.", "Tu cuerpo puede soportar casi cualquier cosa. Es a tu mente a la que tienes que convencer.",
                "El secreto para salir adelante es empezar.", "No se trata de ser perfecto. Se trata de ser constante.",
                "Cada comida es una oportunidad para nutrir tu cuerpo.", "El éxito es la suma de pequeños esfuerzos repetidos día tras día."
            ];

            const ingredientPools = {
                desayuno: {
                    'Grasas Saludables': [{ name: 'Aguacate', portion: '1/4 mediano' }, { name: 'Maní quebrado', portion: '2 cdas' }, { name: 'Nata de leche fresca', portion: '1 cda' }, { name: 'Semillas de Sambo', portion: '1 cda' }, { name: 'Nueces', portion: '5 unidades' }],
                    'Proteínas': [{ name: 'Huevo criollo', portion: '2 unidades' }, { name: 'Quesito de hoja', portion: '2 rebanadas' }, { name: 'Leche de finca', portion: '1 vaso' }, { name: 'Yogur de pajarito', portion: '1 taza' }],
                    'Verduras': [{ name: 'Bolón de verde asado', portion: '1/2 unidad' }, { name: 'Majado de verde', portion: '1/2 taza' }, { name: 'Avena en hojuelas', portion: '1/2 taza' }, { name: 'Frutas de temporada', portion: '1 taza' }, { name: 'Jugo de naranjilla', portion: '1 vaso' }]
                },
                almuerzo: {
                    'Grasas Saludables': [{ name: 'Aguacate para menestra', portion: '1/4 mediano' }, { name: 'Aceite de achiote', portion: '1 cdta' }, { name: 'Maní en salsa', portion: '2 cdas' }, { name: 'Aceite de Oliva', portion: '1 cda' }],
                    'Proteínas': [{ name: 'Pechuga de pollo', portion: '1 filete (120g)' }, { name: 'Menestra de lenteja', portion: '1 taza' }, { name: 'Trucha al ajillo', portion: '1 filete (150g)' }, { name: 'Menestra de fréjol', portion: '1 taza' }, { name: 'Corvina (al horno)', portion: '1 filete (150g)' }, { name: 'Carne en bistec', portion: '1 filete (120g)' }],
                    'Verduras': [{ name: 'Arroz integral', portion: '1/2 taza' }, { name: 'Patacones (al horno)', portion: '4 unidades' }, { name: 'Ensalada criolla', portion: '2 tazas' }, { name: 'Morocho partido', portion: '1/2 taza' }, { name: 'Yuca al vapor', portion: '1/2 taza' }, { name: 'Maduro asado', portion: '1/2 unidad' }, { name: 'Mote pillo', portion: '1/2 taza' }]
                },
                cena: {
                    'Grasas Saludables': [{ name: 'Aceite de oliva', portion: '1 cda' }, { name: 'Aguacate', portion: '1/8 mediano' }, { name: 'Nueces', portion: '4 unidades' }],
                    'Proteínas': [{ name: 'Caldo de gallina criolla', portion: '1 plato' }, { name: 'Humita de sal', portion: '1 unidad' }, { name: 'Chochos con tostado', portion: '1 taza' }, { name: 'Pescado encocado (light)', portion: '1 filete (120g)' }],
                    'Verduras': [{ name: 'Ensalada de vegetales frescos', portion: '2 tazas' }, { name: 'Calabacín salteado', portion: '1 taza' }, { name: 'Brócoli al vapor', portion: '1 taza' }, { name: 'Sopa de quinua', portion: '1 plato' }, { name: 'Mellocos salteados', portion: '1/2 taza' }]
                }
            };
            
            function formatDate(date) { return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; }
            function getCalories(food) { const key = food.toLowerCase().trim(); const dbKey = Object.keys(calorieDatabase).find(k => key.includes(k)); return calorieDatabase[dbKey] || 100; }
            function getDayOfYear(date) { const start = new Date(date.getFullYear(), 0, 0); return Math.floor((date - start) / (1000 * 60 * 60 * 24)); }
            
            function saveState() { localStorage.setItem('dietAppState_v1', JSON.stringify(state)); }
            function loadState() {
                const savedState = localStorage.getItem('dietAppState_v1');
                if (savedState) {
                    state = JSON.parse(savedState);
                }
                 if (!state.userProfile || !state.userProfile.profileComplete) {
                    document.getElementById('welcome-banner').classList.remove('hidden');
                }
            }
            
            function getDailySuggestions(dayOfYear) {
                const suggestions = { desayuno: {}, almuerzo: {}, cena: {}, snacks: {} };
                for (const mealKey in ingredientPools) {
                    suggestions[mealKey] = {};
                    for (const categoryKey in ingredientPools[mealKey]) {
                        const pool = ingredientPools[mealKey][categoryKey];
                        const shuffled = [...pool].sort((a, b) => {
                            const seed = dayOfYear + categoryKey.charCodeAt(0) + mealKey.charCodeAt(0);
                            return (a.name.charCodeAt(0) * seed) % 13 - (b.name.charCodeAt(0) * seed) % 13;
                        });
                        suggestions[mealKey][categoryKey] = shuffled.slice(0, 5);
                    }
                }
                suggestions.snacks = suggestions.desayuno;
                return suggestions;
            }

            function render() {
                document.getElementById('date-picker').value = state.selectedDate;
                const dayOfYear = getDayOfYear(new Date(`${state.selectedDate}T12:00:00Z`));
                const dailySuggestions = getDailySuggestions(dayOfYear);

                const mealsContainer = document.getElementById('meals-container');
                mealsContainer.innerHTML = `
                    ${renderMealSection('Desayuno', dailySuggestions.desayuno)}
                    ${renderMealSection('Almuerzo', dailySuggestions.almuerzo)}
                    ${renderMealSection('Cena', dailySuggestions.cena)}
                    ${renderMealSection('Snacks', dailySuggestions.snacks)}
                `;
                
                renderTotals();
                updateGenerateRecipesButtonState();
                document.getElementById('quote-text').textContent = `"${motivationalQuotes[dayOfYear % motivationalQuotes.length]}"`;
                addEventListenersToRenderedItems();
                lucide.createIcons();
            }

            function renderMealSection(mealName, suggestions) {
                const mealKey = mealName.toLowerCase();
                const mealData = state.dietLog[state.selectedDate]?.[mealKey] || { fats: [], proteins: [], vegetables: [] };
                const totalCalories = Object.values(mealData).flat().reduce((sum, food) => sum + food.calories, 0);

                return `
                    <div class="mb-10">
                        <div class="flex flex-wrap justify-between items-end mb-5 pb-3 border-b-2 border-gray-200 gap-4">
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">${mealName}</h2>
                            <div class="flex items-center gap-4">
                                <button class="generate-image-btn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm font-semibold flex items-center" data-meal-key="${mealKey}"><i data-lucide="image" class="w-4 h-4 mr-2"></i>Ver Mi Plato</button>
                                <div class="flex items-center text-emerald-600 font-bold"><i data-lucide="flame" class="w-6 h-6 mr-2"></i><span class="text-xl md:text-2xl">${totalCalories} kcal</span></div>
                            </div>
                        </div>
                        <div id="image-container-${mealKey}" class="my-4 flex justify-center items-center bg-gray-100 rounded-lg min-h-[256px] hidden"></div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            ${renderFoodCategory('Grasas Saludables', 'fats', mealKey, mealData.fats, suggestions)}
                            ${renderFoodCategory('Proteínas', 'proteins', mealKey, mealData.proteins, suggestions)}
                            ${renderFoodCategory('Verduras', 'vegetables', mealKey, mealData.vegetables, suggestions)}
                        </div>
                    </div>
                `;
            }

            function renderFoodCategory(title, categoryKey, mealKey, foods, suggestions) {
                 const categorySuggestions = suggestions[title] || [];
                 return `
                    <div class="bg-white p-5 rounded-xl shadow-md h-full flex flex-col border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">${title}</h3>
                        <div class="mb-4"><div class="flex flex-wrap">
                            ${categorySuggestions.map(s => `<button class="suggestion-pill flex flex-col items-start bg-emerald-100 text-emerald-800 text-xs font-semibold p-2 rounded-lg hover:bg-emerald-200 hover:scale-105 transform transition-all duration-200 mr-2 mb-2" data-food-name="${s.name}" data-category="${categoryKey}" data-meal="${mealKey}"><span class="flex items-center"><i data-lucide="plus" class="w-3.5 h-3.5 mr-1.5"></i>${s.name}</span><span class="text-emerald-700 text-[10px] font-medium mt-1 ml-5">${s.portion}</span></button>`).join('')}
                        </div></div>
                        <div class="flex mb-4">
                            <input type="text" placeholder="Añadir alimento..." class="food-input flex-grow p-2.5 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow" data-category="${categoryKey}" data-meal="${mealKey}" />
                            <button class="add-food-btn bg-emerald-500 text-white p-2.5 rounded-r-lg hover:bg-emerald-600 transition-colors duration-200" data-category="${categoryKey}" data-meal="${mealKey}"><i data-lucide="plus" class="w-5 h-5"></i></button>
                        </div>
                        <ul class="space-y-2.5 overflow-y-auto flex-grow pr-2 -mr-2">
                            ${foods.map((food, index) => `<li class="flex justify-between items-center bg-gray-50 p-2.5 rounded-lg group transition-all duration-200 hover:bg-gray-100"><span class="text-gray-700 font-medium">${food.name}</span><div class="flex items-center"><span class="text-sm text-gray-500 font-semibold mr-4">${food.calories} kcal</span><button class="remove-food-btn text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" data-category="${categoryKey}" data-meal="${mealKey}" data-index="${index}"><i data-lucide="trash-2" class="w-4.5 h-4.5"></i></button></div></li>`).join('')}
                            ${foods.length === 0 ? '<p class="text-gray-400 text-sm text-center italic mt-4">No hay alimentos.</p>' : ''}
                        </ul>
                    </div>
                 `;
            }
            
            function renderTotals() {
                const todayData = state.dietLog[state.selectedDate] || {};
                const dailyTotalCalories = Object.values(todayData).reduce((mealSum, meal) => mealSum + Object.values(meal).flat().reduce((catSum, food) => catSum + food.calories, 0), 0);
                const progress = Math.min((dailyTotalCalories / state.calorieGoal) * 100, 100);

                document.getElementById('daily-total-calories').textContent = `${dailyTotalCalories} kcal`;
                document.getElementById('calorie-goal-text').textContent = `Objetivo: ${state.calorieGoal} kcal`;
                document.getElementById('progress-bar').style.width = `${progress}%`;
            }
            
            function updateGenerateRecipesButtonState() {
                const container = document.getElementById('recipe-button-container');
                const dayData = state.dietLog[state.selectedDate];
                const isReady = dayData && dayData.desayuno?.proteins.length > 0 && dayData.almuerzo?.proteins.length > 0 && dayData.cena?.proteins.length > 0;
                
                container.innerHTML = `<button id="generate-recipes-btn" class="bg-green-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-green-700 transition-all text-lg flex items-center disabled:bg-gray-400 disabled:cursor-not-allowed" ${!isReady ? 'disabled' : ''}><i data-lucide="chef-hat" class="w-6 h-6 mr-3"></i>Generar Recetas del Día</button>`;
                document.getElementById('generate-recipes-btn').addEventListener('click', generateDailyRecipes);
                lucide.createIcons();
            }

            async function apiCallWithRetries(apiUrl, payload, maxRetries = 3) {
                let attempt = 0;
                let delay = 1000;
                while (attempt < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                        const result = await response.json();
                        return result; // Success
                    } catch (error) {
                        console.error(`Attempt ${attempt + 1} failed:`, error);
                        attempt++;
                        if (attempt >= maxRetries) throw error; // Rethrow error after max retries
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    }
                }
            }

            async function generatePlateImage(mealKey) {
                const container = document.getElementById(`image-container-${mealKey}`);
                if (!container) return;
                container.classList.remove('hidden');
                const mealData = state.dietLog[state.selectedDate]?.[mealKey];
                const selectedFoods = mealData ? [...mealData.proteins, ...mealData.fats, ...mealData.vegetables].map(f => f.name) : [];
                if (selectedFoods.length === 0) { container.innerHTML = `<p class="text-gray-500 text-center p-4">Añade alimentos a tu comida para generar una imagen del plato.</p>`; return; }
                container.innerHTML = '<div class="loader"></div>';
                const prompt = `Fotografía realista de un plato saludable ecuatoriano para el ${mealKey}. El plato contiene porciones de ${selectedFoods.join(', ')}. Vista superior, plato blanco, fondo de madera rústica, luz natural.`;
                try {
                    const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                    const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
                    const result = await apiCallWithRetries(apiUrl, payload);
                    if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                        container.innerHTML = `<img src="data:image/png;base64,${result.predictions[0].bytesBase64Encoded}" alt="Plato personalizado para ${mealKey}" class="w-full h-full object-cover rounded-lg"/>`;
                    } else { throw new Error("No se recibió una imagen válida."); }
                } catch (error) { console.error("Error al generar la imagen:", error); container.innerHTML = `<p class="text-red-500 text-center p-4">Error al generar la imagen. Inténtalo de nuevo.</p>`; }
            }

            async function generateDailyRecipes() {
                const recipeModal = document.getElementById('recipe-modal');
                const recipeContent = document.getElementById('recipe-content-container');
                recipeModal.classList.remove('hidden');
                recipeContent.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';
                const dayData = state.dietLog[state.selectedDate];
                const breakfastItems = [...dayData.desayuno.proteins, ...dayData.desayuno.fats, ...dayData.desayuno.vegetables].map(f => f.name).join(', ');
                const lunchItems = [...dayData.almuerzo.proteins, ...dayData.almuerzo.fats, ...dayData.almuerzo.vegetables].map(f => f.name).join(', ');
                const dinnerItems = [...dayData.cena.proteins, ...dayData.cena.fats, ...dayData.cena.vegetables].map(f => f.name).join(', ');
                const prompt = `Eres un chef ecuatoriano experto en cocina saludable. Crea recetas sencillas y paso a paso para un día completo usando únicamente los siguientes ingredientes. Proporciona un nombre creativo para cada plato. Formatea la respuesta en HTML bien estructurado:
                - Usa '<h3 class="font-extrabold text-xl text-emerald-600 mb-2 pb-1 border-b-2 border-emerald-200">' para los títulos de las comidas (Desayuno, Almuerzo, Cena).
                - Usa '<h4 class="font-semibold text-lg text-gray-800 mb-2">' para el nombre del plato.
                - Usa '<p class="font-semibold text-gray-700 mt-3 mb-1">Instrucciones:</p>'.
                - Usa una lista no ordenada '<ul>' con '<li>' para los pasos de la preparación.
                Desayuno: ${breakfastItems}.
                Almuerzo: ${lunchItems}.
                Cena: ${dinnerItems}.`;
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const result = await apiCallWithRetries(apiUrl, payload);
                    recipeContent.innerHTML = result.candidates[0].content.parts[0].text;
                } catch (error) { console.error("Error generating recipes:", error); recipeContent.innerHTML = `<p class="text-red-500 text-center p-4">Error al generar las recetas. Por favor, inténtalo de nuevo.</p>`; }
            }

            function addFood(category, meal, foodName) {
                if (!foodName.trim()) return;
                const foodItem = { name: foodName.trim(), calories: getCalories(foodName) };
                if (!state.dietLog[state.selectedDate]) {
                    state.dietLog[state.selectedDate] = { desayuno: {fats:[],proteins:[],vegetables:[]}, almuerzo: {fats:[],proteins:[],vegetables:[]}, cena: {fats:[],proteins:[],vegetables:[]}, snacks: {fats:[],proteins:[],vegetables:[]} };
                }
                state.dietLog[state.selectedDate][meal][category].push(foodItem);
                saveState();
                render();
            }

            function removeFood(category, meal, index) {
                state.dietLog[state.selectedDate]?.[meal]?.[category]?.splice(index, 1);
                saveState();
                render();
            }

            function changeDay(amount) {
                const currentDate = new Date(`${state.selectedDate}T12:00:00Z`);
                currentDate.setDate(currentDate.getDate() + amount);
                state.selectedDate = formatDate(currentDate);
                render();
            }
            
            function handleModalCalculations() {
                const profile = {
                    gender: document.getElementById('gender-input').value,
                    age: document.getElementById('age-input').value,
                    weight: document.getElementById('weight-input').value,
                    height: document.getElementById('height-input').value,
                    activityLevel: document.getElementById('activity-level-input').value,
                };
                
                const { weight, height, age, gender, activityLevel } = profile;
                if (!weight || !height || !age || !gender || !activityLevel) { alert("Por favor, completa todos los campos."); return; }

                let bmr = (gender === 'male') ? (10 * weight + 6.25 * height - 5 * age + 5) : (10 * weight + 6.25 * height - 5 * age - 161);
                const tdee = bmr * parseFloat(activityLevel);
                const calorieGoal = Math.round(tdee - 450);
                const proteinGrams = Math.round((calorieGoal * 0.40) / 4);
                const carbGrams = Math.round((calorieGoal * 0.30) / 4);
                const fatGrams = Math.round((calorieGoal * 0.30) / 9);

                const results = { calorieGoal, proteinGrams, carbGrams, fatGrams };
                
                document.getElementById('modal-results-content').innerHTML = `
                    <div><p class="text-2xl font-bold text-emerald-600">${results.calorieGoal}</p><p class="text-sm text-gray-600">Calorías</p></div>
                    <div><p class="text-2xl font-bold text-emerald-600">${results.proteinGrams} g</p><p class="text-sm text-gray-600">Proteínas</p></div>
                    <div><p class="text-2xl font-bold text-emerald-600">${results.carbGrams} g</p><p class="text-sm text-gray-600">Carbs</p></div>
                    <div><p class="text-2xl font-bold text-emerald-600">${results.fatGrams} g</p><p class="text-sm text-gray-600">Grasas</p></div>
                `;

                document.getElementById('modal-explanation-content').innerHTML = `
                    <p><strong>1. Metabolismo Basal (TMB):</strong> Tu cuerpo, en reposo total, necesita aproximadamente <strong>${Math.round(bmr)} kcal</strong> solo para mantener sus funciones vitales.</p>
                    <p><strong>2. Gasto Energético Total (GETD):</strong> Al incluir tu nivel de actividad, tu gasto diario real es de unas <strong>${Math.round(tdee)} kcal</strong>.</p>
                    <p><strong>3. Objetivo con Déficit:</strong> Para perder peso de forma sostenible mientras proteges tu masa muscular, aplicamos un déficit moderado. Restamos unas 450 kcal a tu gasto total, resultando en tu objetivo de <strong>${calorieGoal} kcal</strong>. Esto promueve la quema de grasa sin afectar negativamente tu energía o músculo.</p>
                `;
                
                document.getElementById('modal-results-container').classList.remove('hidden');
                
                document.getElementById('save-goals-btn').dataset.results = JSON.stringify(results);
                document.getElementById('save-goals-btn').dataset.profile = JSON.stringify(profile);
            }

            function saveAndApplyGoals(e) {
                const results = JSON.parse(e.currentTarget.dataset.results);
                const profile = JSON.parse(e.currentTarget.dataset.profile);
                
                state.userProfile = { ...profile, profileComplete: true };
                state.calorieGoal = results.calorieGoal;
                
                saveState();
                
                document.getElementById('goal-modal').classList.add('hidden');
                document.getElementById('welcome-banner').classList.add('hidden');
                render();
            }
            
            function showProgress() {
                const progressModal = document.getElementById('progress-modal');
                progressModal.classList.remove('hidden');
                
                const labels = [];
                const data = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateString = formatDate(date);
                    labels.push(dateString.substring(5)); // 'MM-DD'
                    
                    const logData = state.dietLog[dateString] || {};
                    const dailyTotal = Object.values(logData).reduce((mealSum, meal) => mealSum + Object.values(meal).flat().reduce((catSum, food) => catSum + food.calories, 0), 0);
                    data.push(dailyTotal);
                }

                const ctx = document.getElementById('progress-chart').getContext('2d');
                if (progressChart) {
                    progressChart.destroy();
                }
                progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Calorías Consumidas',
                            data: data,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        }, {
                            label: 'Objetivo de Calorías',
                            data: Array(7).fill(state.calorieGoal),
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
            
            function exportRecipesToPDF() {
                const recipeContent = document.getElementById('recipe-content-container');
                const doc = new jsPDF();

                html2canvas(recipeContent, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps= doc.getImageProperties(imgData);
                    const pdfWidth = doc.internal.pageSize.getWidth() - 20; // Margins
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    doc.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
                    doc.save(`recetario-${state.selectedDate}.pdf`);
                });
            }

            function addEventListenersToRenderedItems() {
                document.querySelectorAll('.add-food-btn').forEach(btn => btn.addEventListener('click', (e) => { const input = e.currentTarget.previousElementSibling; addFood(input.dataset.category, input.dataset.meal, input.value); }));
                document.querySelectorAll('.food-input').forEach(input => input.addEventListener('keypress', (e) => { if (e.key === 'Enter') { addFood(e.target.dataset.category, e.target.dataset.meal, e.target.value); } }));
                document.querySelectorAll('.remove-food-btn').forEach(btn => btn.addEventListener('click', (e) => { const { category, meal, index } = e.currentTarget.dataset; removeFood(category, meal, parseInt(index)); }));
                document.querySelectorAll('.suggestion-pill').forEach(btn => btn.addEventListener('click', (e) => { const { foodName, category, meal } = e.currentTarget.dataset; addFood(category, meal, foodName); }));
                document.querySelectorAll('.generate-image-btn').forEach(btn => btn.addEventListener('click', (e) => { generatePlateImage(e.currentTarget.dataset.mealKey); }));
                document.getElementById('toggle-principles-btn')?.addEventListener('click', () => { document.getElementById('principles-content').classList.toggle('open'); document.getElementById('principles-arrow').classList.toggle('rotate-180'); });
            }
            
            function setupGlobalListeners() {
                document.getElementById('date-picker').addEventListener('change', (e) => { state.selectedDate = e.target.value; render(); });
                document.getElementById('prev-day-btn').addEventListener('click', () => changeDay(-1));
                document.getElementById('next-day-btn').addEventListener('click', () => changeDay(1));
                document.getElementById('open-modal-btn').addEventListener('click', () => document.getElementById('goal-modal').classList.remove('hidden'));
                document.getElementById('close-goal-modal-btn').addEventListener('click', () => document.getElementById('goal-modal').classList.add('hidden'));
                document.getElementById('calculate-goals-btn').addEventListener('click', handleModalCalculations);
                document.getElementById('save-goals-btn').addEventListener('click', saveAndApplyGoals);
                document.getElementById('close-recipe-modal-btn').addEventListener('click', () => document.getElementById('recipe-modal').classList.add('hidden'));
                document.getElementById('export-pdf-btn').addEventListener('click', exportRecipesToPDF);
                document.getElementById('progress-btn').addEventListener('click', showProgress);
                document.getElementById('close-progress-modal-btn').addEventListener('click', () => document.getElementById('progress-modal').classList.add('hidden'));
                document.getElementById('welcome-define-goals-btn').addEventListener('click', () => document.getElementById('goal-modal').classList.remove('hidden'));
            }

            loadState();
            setupGlobalListeners();
            render();
        });
    </script>
</body>
</html>
