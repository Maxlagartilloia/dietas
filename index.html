<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DietaryTrack | Dashboard de Dieta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .details-content.open {
            max-height: 1000px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Modal de Metas -->
    <div id="goal-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl transform transition-all overflow-y-auto max-h-screen">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Define Tus Metas</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-7 h-7"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Género</label>
                    <select id="gender-input" name="gender" class="w-full p-2.5 border border-gray-300 rounded-lg">
                        <option value="">Seleccionar...</option>
                        <option value="male">Masculino</option>
                        <option value="female">Femenino</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Edad</label>
                    <input type="number" id="age-input" name="age" placeholder="ej. 30" class="w-full p-2.5 border border-gray-300 rounded-lg" />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Peso (kg)</label>
                    <input type="number" id="weight-input" name="weight" placeholder="ej. 70" class="w-full p-2.5 border border-gray-300 rounded-lg" />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Estatura (cm)</label>
                    <input type="number" id="height-input" name="height" placeholder="ej. 175" class="w-full p-2.5 border border-gray-300 rounded-lg" />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-600 mb-1">Nivel de Actividad</label>
                    <select id="activity-level-input" name="activityLevel" class="w-full p-2.5 border border-gray-300 rounded-lg">
                        <option value="">Seleccionar...</option>
                        <option value="1.2">Sedentario</option>
                        <option value="1.375">Ligero (1-3 días/sem)</option>
                        <option value="1.55">Moderado (3-5 días/sem)</option>
                        <option value="1.725">Fuerte (6-7 días/sem)</option>
                        <option value="1.9">Muy Fuerte (2x día)</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-center mb-6">
                <button id="calculate-goals-btn" class="bg-emerald-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-emerald-600 transition-colors text-lg">
                    Calcular Mis Metas
                </button>
            </div>
            <div id="modal-results-container" class="hidden">
                 <div class="bg-emerald-50 p-6 rounded-xl border border-emerald-200">
                    <h3 class="text-xl font-bold text-emerald-800 mb-4 text-center">Tus Objetivos Diarios</h3>
                    <div id="modal-results-content" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"></div>
                </div>
                <!-- Nueva sección de explicación -->
                <div class="mt-6 bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Entiende tu Objetivo</h3>
                    <div id="modal-explanation-content" class="text-sm text-gray-700 space-y-3"></div>
                </div>
                 <div class="mt-6 flex justify-center">
                     <button id="save-goals-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors">
                        Guardar y Usar Metas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <header class="bg-white shadow-sm sticky top-0 z-10 border-b border-gray-200">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center">
                    <div class="bg-emerald-500 p-2 rounded-lg mr-3"><i data-lucide="zap" class="text-white w-6 h-6"></i></div>
                    <h1 class="text-2xl font-extrabold text-gray-800">Dietary<span class="text-emerald-500">Track</span></h1>
                </div>
                <div class="flex items-center bg-gray-100 p-1.5 rounded-xl">
                    <button id="prev-day-btn" class="p-2 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <div class="relative mx-2">
                        <i data-lucide="calendar" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none w-5 h-5"></i>
                        <input type="date" id="date-picker" class="bg-white border-2 border-gray-200 rounded-lg p-2 pl-10 w-40 text-left font-semibold text-gray-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
                    </div>
                    <button id="next-day-btn" class="p-2 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
                <div class="w-full md:w-auto lg:w-1/3 bg-gray-100 p-3 rounded-xl">
                    <div class="flex justify-between items-center mb-1 text-sm font-semibold">
                        <span class="text-emerald-600">Consumido</span>
                        <button id="open-modal-btn" class="flex items-center text-gray-500 hover:text-emerald-600 transition-colors">
                            <i data-lucide="target" class="w-4 h-4 mr-1"></i>
                            <span id="calorie-goal-text">Objetivo: 2000 kcal</span>
                        </button>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-emerald-500 h-2.5 rounded-full" style="width: 0%;"></div>
                    </div>
                    <p id="daily-total-calories" class="text-right font-bold text-gray-700 mt-1">0 kcal</p>
                </div>
            </div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto p-4 md:p-8">
        <div class="mb-10 bg-white p-6 rounded-xl shadow-md border border-gray-100">
            <button id="toggle-principles-btn" class="w-full flex justify-between items-center text-left">
                <h2 class="text-2xl font-bold text-gray-800">Principios Clave para tu Éxito</h2>
                <i data-lucide="chevron-down" id="principles-arrow" class="w-6 h-6 transition-transform"></i>
            </button>
            <div id="principles-content" class="details-content mt-4 text-gray-600">
                <ul class="space-y-4">
                    <li class="flex items-start"><i data-lucide="shield-check" class="w-5 h-5 mr-3 text-emerald-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Equilibrio de Macronutrientes:</strong> Prioriza las proteínas (1.6-2.2 g/kg de peso) para construir músculo, carbohidratos complejos (quinua, morocho, yuca) para energía sostenida y grasas saludables (aguacate, nueces) para la función hormonal.</span></li>
                    <li class="flex items-start"><i data-lucide="droplets" class="w-5 h-5 mr-3 text-blue-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Hidratación Constante:</strong> Bebe al menos 2 litros de agua al día. Es vital para el rendimiento muscular y el metabolismo.</span></li>
                    <li class="flex items-start"><i data-lucide="bed-double" class="w-5 h-5 mr-3 text-indigo-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Descanso Reparador:</strong> Dormir 7-9 horas es crucial. El descanso optimiza las hormonas que regulan el hambre y favorecen el crecimiento muscular.</span></li>
                    <li class="flex items-start"><i data-lucide="dumbbell" class="w-5 h-5 mr-3 text-red-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Actividad Física Combinada:</strong> Acompaña tu dieta con ejercicios de fuerza (pesas, CrossFit) y cardio (caminar, trotar) para maximizar la quema de grasa y la ganancia de músculo.</span></li>
                    <li class="flex items-start"><i data-lucide="ban" class="w-5 h-5 mr-3 text-gray-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Evita lo que no te suma:</strong> Limita al máximo los azúcares añadidos, alimentos ultraprocesados, frituras y alcohol. Aportan calorías vacías y dificultan tus objetivos.</span></li>
                    <li class="flex items-start"><i data-lucide="stethoscope" class="w-5 h-5 mr-3 text-teal-500 mt-1 shrink-0"></i><span><strong class="font-semibold text-gray-700">Consulta Profesional:</strong> Estas son guías excelentes, pero un nutricionista puede crear un plan perfectamente adaptado a ti.</span></li>
                </ul>
            </div>
        </div>
    </main>

    <footer class="text-center py-8 px-4">
        <div class="bg-white p-6 rounded-xl max-w-2xl mx-auto shadow-lg border border-gray-100">
            <p id="quote-text" class="text-gray-500 italic text-lg"></p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let state = {
                dietLog: {},
                userProfile: { weight: '', height: '', age: '', gender: '', activityLevel: '' },
                calorieGoal: 2000,
                selectedDate: formatDate(new Date()),
            };

            const calorieDatabase = {
                'aguacate': 160, 'nueces de macadamia': 718, 'sacha inchi': 600, 'aceite de coco': 862, 'maní': 567, 'nueces': 654, 'aceite de oliva': 884, 'semillas de chía': 486, 'almendras': 579,
                'chochos': 120, 'quinua': 120, 'pescado (corvina)': 95, 'camarones': 85, 'pollo': 239, 'huevo': 155, 'lenteja serrana': 115, 'tofu': 76, 'carne magra': 250, 'lentejas': 116, 'queso fresco': 299, 'trucha': 148, 'garbanzo': 139, 'leche': 42, 'yogur natural': 61, 'fréjol': 130,
                'tomate de árbol': 50, 'brócoli': 34, 'espinaca': 23, 'pimiento': 20, 'yuca': 160, 'melloco': 55, 'plátano verde': 122, 'frutillas': 32, 'babaco': 23, 'avena': 389, 'zanahoria': 41, 'tomate': 18, 'calabacín': 17, 'mote': 100, 'naranjilla': 25, 'granadilla': 97, 'pepino': 15, 'cebolla': 40, 'lechuga': 15, 'papaya': 43, 'piña': 50, 'melón': 34, 'morocho partido': 110, 'acelga': 19, 'maracuyá': 97, 'batata (camote)': 86
            };

            const motivationalQuotes = [
                "La disciplina es el puente entre las metas y los logros.", "Tu cuerpo puede soportar casi cualquier cosa. Es a tu mente a la que tienes que convencer.",
                "El secreto para salir adelante es empezar.", "No se trata de ser perfecto. Se trata de ser constante.",
                "Cada comida es una oportunidad para nutrir tu cuerpo.", "El éxito es la suma de pequeños esfuerzos repetidos día tras día."
            ];

            // Bancos de ingredientes separados y más grandes para máxima variedad
            const ingredientPools = {
                desayuno: {
                    'Grasas Saludables': [{ name: 'Aguacate', portion: '1/4 mediano' }, { name: 'Maní', portion: '2 cdas' }, { name: 'Nueces', portion: '5 unidades' }, { name: 'Semillas de Chía', portion: '1 cda' }, { name: 'Almendras', portion: '10 unidades' }, { name: 'Sacha Inchi', portion: '1 cda' }],
                    'Proteínas': [{ name: 'Huevo', portion: '2 unidades' }, { name: 'Yogur Natural', portion: '1 taza' }, { name: 'Queso Fresco', portion: '2 rebanadas' }, { name: 'Leche', portion: '1 vaso' }],
                    'Verduras': [{ name: 'Frutillas', portion: '1 taza' }, { name: 'Babaco', portion: '1 rodaja' }, { name: 'Avena', portion: '1/2 taza' }, { name: 'Granadilla', portion: '2 unidades' }, { name: 'Naranjilla', portion: '2 unidades' }, { name: 'Papaya', portion: '1 taza' }, { name: 'Tomate de Árbol', portion: '1 unidad' }, { name: 'Maracuyá', portion: '2 unidades' }]
                },
                almuerzo: {
                    'Grasas Saludables': [{ name: 'Aceite de Oliva', portion: '1 cda' }, { name: 'Nueces de Macadamia', portion: '5 unidades' }, { name: 'Maní Tostado', portion: '2 cdas' }],
                    'Proteínas': [{ name: 'Pollo', portion: '1 filete (120g)' }, { name: 'Lenteja Serrana', portion: '1 taza cocida' }, { name: 'Trucha', portion: '1 filete (150g)' }, { name: 'Fréjol', portion: '1 taza cocida' }, { name: 'Pescado (Corvina)', portion: '1 filete (150g)' }, { name: 'Carne Magra', portion: '1 filete (120g)' }, { name: 'Garbanzo', portion: '1 taza cocida' }],
                    'Verduras': [{ name: 'Brócoli', portion: '1 taza' }, { name: 'Zanahoria', portion: '1/2 taza' }, { name: 'Acelga', portion: '2 tazas' }, { name: 'Morocho partido', portion: '1/2 taza' }, { name: 'Lechuga', portion: '2 tazas' }, { name: 'Yuca', portion: '1/2 taza' }, { name: 'Batata (Camote)', portion: '1/2 taza' }, { name: 'Mote', portion: '1/2 taza' }, { name: 'Quinua', portion: '1 taza cocida' }]
                },
                cena: {
                    'Grasas Saludables': [{ name: 'Aceite de Coco', portion: '1 cdta' }, { name: 'Aguacate', portion: '1/8 mediano' }, { name: 'Almendras', portion: '5 unidades' }],
                    'Proteínas': [{ name: 'Camarones', portion: '150g' }, { name: 'Tofu', portion: '120g' }, { name: 'Chochos', portion: '1 taza' }, { name: 'Pechuga de Pavo', portion: '100g' }],
                    'Verduras': [{ name: 'Espinaca', portion: '2 tazas' }, { name: 'Calabacín', portion: '1 taza' }, { name: 'Pimiento', portion: '1/2 unidad' }, { name: 'Melloco', portion: '1/2 taza' }, { name: 'Pepino', portion: '1 taza' }, { name: 'Tomate', portion: '1 unidad' }]
                }
            };

            function formatDate(date) {
                return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            }

            function getCalories(food) {
                const foodKey = food.toLowerCase().trim();
                const dbKey = Object.keys(calorieDatabase).find(k => foodKey.includes(k));
                return calorieDatabase[dbKey] || 100;
            }

            function getDayOfYear(date) {
                const start = new Date(date.getFullYear(), 0, 0);
                const diff = date - start;
                const oneDay = 1000 * 60 * 60 * 24;
                return Math.floor(diff / oneDay);
            }
            
            function saveState() {
                localStorage.setItem('dietAppState', JSON.stringify(state));
            }

            function loadState() {
                const savedState = localStorage.getItem('dietAppState');
                if (savedState) {
                    state = JSON.parse(savedState);
                    if (!localStorage.getItem('hasLoadedBeforeV6')) {
                        state.selectedDate = formatDate(new Date());
                        localStorage.setItem('hasLoadedBeforeV6', 'true');
                    }
                }
            }
            
            function getDailySuggestions(dayOfYear) {
                const suggestions = { desayuno: {}, almuerzo: {}, cena: {}, snacks: {} };
                for (const mealKey in ingredientPools) {
                    suggestions[mealKey] = {};
                    for (const categoryKey in ingredientPools[mealKey]) {
                        const pool = ingredientPools[mealKey][categoryKey];
                        const shuffled = [...pool].sort((a, b) => {
                            const seed = dayOfYear + categoryKey.charCodeAt(0) + mealKey.charCodeAt(0);
                            return (a.name.charCodeAt(0) * seed) % 13 - (b.name.charCodeAt(0) * seed) % 13;
                        });
                        suggestions[mealKey][categoryKey] = shuffled.slice(0, 5);
                    }
                }
                suggestions.snacks = suggestions.desayuno;
                return suggestions;
            }

            function render() {
                document.getElementById('date-picker').value = state.selectedDate;
                const dayOfYear = getDayOfYear(new Date(`${state.selectedDate}T12:00:00`));
                const dailySuggestions = getDailySuggestions(dayOfYear);

                const mainContent = document.getElementById('main-content');
                const principlesSection = mainContent.querySelector('.mb-10.bg-white');
                mainContent.innerHTML = '';
                if (principlesSection) mainContent.appendChild(principlesSection);
                
                mainContent.innerHTML += `
                    ${renderMealSection('Desayuno', dailySuggestions.desayuno)}
                    ${renderMealSection('Almuerzo', dailySuggestions.almuerzo)}
                    ${renderMealSection('Cena', dailySuggestions.cena)}
                    ${renderMealSection('Snacks', dailySuggestions.snacks)}
                `;
                
                renderTotals();
                document.getElementById('quote-text').textContent = `"${motivationalQuotes[dayOfYear % motivationalQuotes.length]}"`;
                addEventListenersToRenderedItems();
                lucide.createIcons();
            }

            function renderMealSection(mealName, suggestions) {
                const mealKey = mealName.toLowerCase();
                const mealData = state.dietLog[state.selectedDate]?.[mealKey] || { fats: [], proteins: [], vegetables: [] };
                const totalCalories = Object.values(mealData).flat().reduce((sum, food) => sum + food.calories, 0);

                return `
                    <div class="mb-10">
                        <div class="flex flex-wrap justify-between items-end mb-5 pb-3 border-b-2 border-gray-200 gap-4">
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">${mealName}</h2>
                            <div class="flex items-center gap-4">
                                <button class="generate-image-btn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm font-semibold flex items-center" data-meal-key="${mealKey}">
                                    <i data-lucide="image" class="w-4 h-4 mr-2"></i>Ver Mi Plato
                                </button>
                                <div class="flex items-center text-emerald-600 font-bold">
                                    <i data-lucide="flame" class="w-6 h-6 mr-2"></i>
                                    <span class="text-xl md:text-2xl">${totalCalories} kcal</span>
                                </div>
                            </div>
                        </div>
                        <div id="image-container-${mealKey}" class="my-4 flex justify-center items-center bg-gray-100 rounded-lg min-h-[256px] hidden"></div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            ${renderFoodCategory('Grasas Saludables', 'fats', mealKey, mealData.fats, suggestions)}
                            ${renderFoodCategory('Proteínas', 'proteins', mealKey, mealData.proteins, suggestions)}
                            ${renderFoodCategory('Verduras', 'vegetables', mealKey, mealData.vegetables, suggestions)}
                        </div>
                    </div>
                `;
            }

            function renderFoodCategory(title, categoryKey, mealKey, foods, suggestions) {
                 const categorySuggestions = suggestions[title] || [];
                 return `
                    <div class="bg-white p-5 rounded-xl shadow-md h-full flex flex-col border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">${title}</h3>
                        <div class="mb-4">
                            <div class="flex flex-wrap">
                                ${categorySuggestions.map(s => `
                                    <button class="suggestion-pill flex flex-col items-start bg-emerald-100 text-emerald-800 text-xs font-semibold p-2 rounded-lg hover:bg-emerald-200 hover:scale-105 transform transition-all duration-200 mr-2 mb-2" data-food-name="${s.name}" data-category="${categoryKey}" data-meal="${mealKey}">
                                        <span class="flex items-center"><i data-lucide="plus" class="w-3.5 h-3.5 mr-1.5"></i>${s.name}</span>
                                        <span class="text-emerald-700 text-[10px] font-medium mt-1 ml-5">${s.portion}</span>
                                    </button>`).join('')}
                            </div>
                        </div>
                        <div class="flex mb-4">
                            <input type="text" placeholder="Añadir alimento..." class="food-input flex-grow p-2.5 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow" data-category="${categoryKey}" data-meal="${mealKey}" />
                            <button class="add-food-btn bg-emerald-500 text-white p-2.5 rounded-r-lg hover:bg-emerald-600 transition-colors duration-200" data-category="${categoryKey}" data-meal="${mealKey}"><i data-lucide="plus" class="w-5 h-5"></i></button>
                        </div>
                        <ul class="space-y-2.5 overflow-y-auto flex-grow pr-2 -mr-2">
                            ${foods.map((food, index) => `
                                <li class="flex justify-between items-center bg-gray-50 p-2.5 rounded-lg group transition-all duration-200 hover:bg-gray-100">
                                    <span class="text-gray-700 font-medium">${food.name}</span>
                                    <div class="flex items-center">
                                        <span class="text-sm text-gray-500 font-semibold mr-4">${food.calories} kcal</span>
                                        <button class="remove-food-btn text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" data-category="${categoryKey}" data-meal="${mealKey}" data-index="${index}"><i data-lucide="trash-2" class="w-4.5 h-4.5"></i></button>
                                    </div>
                                </li>
                            `).join('')}
                            ${foods.length === 0 ? '<p class="text-gray-400 text-sm text-center italic mt-4">No hay alimentos.</p>' : ''}
                        </ul>
                    </div>
                 `;
            }
            
            function renderTotals() {
                const todayData = state.dietLog[state.selectedDate] || {};
                const dailyTotalCalories = Object.values(todayData).reduce((mealSum, meal) => mealSum + Object.values(meal).flat().reduce((catSum, food) => catSum + food.calories, 0), 0);
                const progress = Math.min((dailyTotalCalories / state.calorieGoal) * 100, 100);

                document.getElementById('daily-total-calories').textContent = `${dailyTotalCalories} kcal`;
                document.getElementById('calorie-goal-text').textContent = `Objetivo: ${state.calorieGoal} kcal`;
                document.getElementById('progress-bar').style.width = `${progress}%`;
            }

            async function generatePlateImage(mealKey) {
                const container = document.getElementById(`image-container-${mealKey}`);
                if (!container) return;

                container.classList.remove('hidden');
                
                const mealData = state.dietLog[state.selectedDate]?.[mealKey];
                const selectedFoods = mealData ? [...mealData.proteins, ...mealData.fats, ...mealData.vegetables].map(f => f.name) : [];

                if (selectedFoods.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center p-4">Añade alimentos a tu comida para generar una imagen del plato.</p>`;
                    return;
                }

                container.innerHTML = '<div class="loader"></div>';
                const prompt = `Fotografía realista de un plato saludable ecuatoriano para el ${mealKey}. El plato contiene porciones de ${selectedFoods.join(', ')}. Vista superior, plato blanco, fondo de madera rústica, luz natural.`;

                try {
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                    const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`Error en la API: ${response.statusText}`);
                    
                    const result = await response.json();
                    
                    if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                        const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        container.innerHTML = `<img src="${imageUrl}" alt="Plato personalizado para ${mealKey}" class="w-full h-full object-cover rounded-lg"/>`;
                    } else {
                        throw new Error("No se recibió una imagen válida.");
                    }
                } catch (error) {
                    console.error("Error al generar la imagen:", error);
                    container.innerHTML = `<p class="text-red-500 text-center p-4">Error al generar la imagen. Inténtalo de nuevo.</p>`;
                }
            }

            function addFood(category, meal, foodName) {
                if (!foodName.trim()) return;
                const foodItem = { name: foodName.trim(), calories: getCalories(foodName) };
                
                if (!state.dietLog[state.selectedDate]) {
                    state.dietLog[state.selectedDate] = { desayuno: {fats:[],proteins:[],vegetables:[]}, almuerzo: {fats:[],proteins:[],vegetables:[]}, cena: {fats:[],proteins:[],vegetables:[]}, snacks: {fats:[],proteins:[],vegetables:[]} };
                }
                state.dietLog[state.selectedDate][meal][category].push(foodItem);
                saveState();
                render();
            }

            function removeFood(category, meal, index) {
                state.dietLog[state.selectedDate]?.[meal]?.[category]?.splice(index, 1);
                saveState();
                render();
            }

            function changeDay(amount) {
                const currentDate = new Date(`${state.selectedDate}T12:00:00`);
                currentDate.setDate(currentDate.getDate() + amount);
                state.selectedDate = formatDate(currentDate);
                render();
            }
            
            function handleModalCalculations() {
                const profile = {
                    gender: document.getElementById('gender-input').value,
                    age: document.getElementById('age-input').value,
                    weight: document.getElementById('weight-input').value,
                    height: document.getElementById('height-input').value,
                    activityLevel: document.getElementById('activity-level-input').value,
                };
                
                const { weight, height, age, gender, activityLevel } = profile;
                if (!weight || !height || !age || !gender || !activityLevel) { alert("Por favor, completa todos los campos."); return; }

                let bmr = (gender === 'male') ? (10 * weight + 6.25 * height - 5 * age + 5) : (10 * weight + 6.25 * height - 5 * age - 161);
                const tdee = bmr * parseFloat(activityLevel);
                const calorieGoal = Math.round(tdee - 450);
                const proteinGrams = Math.round((calorieGoal * 0.40) / 4);
                const carbGrams = Math.round((calorieGoal * 0.30) / 4);
                const fatGrams = Math.round((calorieGoal * 0.30) / 9);

                const results = { calorieGoal, proteinGrams, carbGrams, fatGrams };
                
                document.getElementById('modal-results-content').innerHTML = `
                    <div><p class="text-2xl font-bold text-emerald-600">${results.calorieGoal}</p><p class="text-sm text-gray-600">Calorías</p></div>
                    <div><p class="text-2xl font-bold text-emerald-600">${results.proteinGrams} g</p><p class="text-sm text-gray-600">Proteínas</p></div>
                    <div><p class="text-2xl font-bold text-emerald-600">${results.carbGrams} g</p><p class="text-sm text-gray-600">Carbs</p></div>
                    <div><p class="text-2xl font-bold text-emerald-600">${results.fatGrams} g</p><p class="text-sm text-gray-600">Grasas</p></div>
                `;

                document.getElementById('modal-explanation-content').innerHTML = `
                    <p><strong>1. Metabolismo Basal (TMB):</strong> Tu cuerpo, en reposo total, necesita aproximadamente <strong>${Math.round(bmr)} kcal</strong> solo para mantener sus funciones vitales.</p>
                    <p><strong>2. Gasto Energético Total (GETD):</strong> Al incluir tu nivel de actividad, tu gasto diario real es de unas <strong>${Math.round(tdee)} kcal</strong>.</p>
                    <p><strong>3. Objetivo con Déficit:</strong> Para perder peso de forma sostenible mientras proteges tu masa muscular, aplicamos un déficit moderado. Restamos unas 450 kcal a tu gasto total, resultando en tu objetivo de <strong>${calorieGoal} kcal</strong>. Esto promueve la quema de grasa sin afectar negativamente tu energía o músculo.</p>
                `;
                
                document.getElementById('modal-results-container').classList.remove('hidden');
                
                document.getElementById('save-goals-btn').dataset.results = JSON.stringify(results);
                document.getElementById('save-goals-btn').dataset.profile = JSON.stringify(profile);
            }

            function saveAndApplyGoals(e) {
                const results = JSON.parse(e.currentTarget.dataset.results);
                const profile = JSON.parse(e.currentTarget.dataset.profile);
                
                state.userProfile = profile;
                state.calorieGoal = results.calorieGoal;
                
                saveState();
                
                document.getElementById('goal-modal').classList.add('hidden');
                render();
            }

            function addEventListenersToRenderedItems() {
                document.querySelectorAll('.add-food-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const input = e.currentTarget.previousElementSibling;
                    addFood(input.dataset.category, input.dataset.meal, input.value);
                }));
                document.querySelectorAll('.food-input').forEach(input => input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addFood(e.target.dataset.category, e.target.dataset.meal, e.target.value);
                    }
                }));
                document.querySelectorAll('.remove-food-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const { category, meal, index } = e.currentTarget.dataset;
                    removeFood(category, meal, parseInt(index));
                }));
                document.querySelectorAll('.suggestion-pill').forEach(btn => btn.addEventListener('click', (e) => {
                    const { foodName, category, meal } = e.currentTarget.dataset;
                    addFood(category, meal, foodName);
                }));
                document.querySelectorAll('.generate-image-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    generatePlateImage(e.currentTarget.dataset.mealKey);
                }));
                 document.getElementById('toggle-principles-btn')?.addEventListener('click', (e) => {
                    const content = document.getElementById('principles-content');
                    const arrow = document.getElementById('principles-arrow');
                    content.classList.toggle('open');
                    arrow.classList.toggle('rotate-180');
                });
            }
            
            function setupGlobalListeners() {
                document.getElementById('date-picker').addEventListener('change', (e) => {
                    state.selectedDate = e.target.value;
                    render();
                });
                document.getElementById('prev-day-btn').addEventListener('click', () => changeDay(-1));
                document.getElementById('next-day-btn').addEventListener('click', () => changeDay(1));

                const goalModal = document.getElementById('goal-modal');
                document.getElementById('open-modal-btn').addEventListener('click', () => goalModal.classList.remove('hidden'));
                document.getElementById('close-modal-btn').addEventListener('click', () => goalModal.classList.add('hidden'));
                document.getElementById('calculate-goals-btn').addEventListener('click', handleModalCalculations);
                document.getElementById('save-goals-btn').addEventListener('click', saveAndApplyGoals);
            }

            loadState();
            setupGlobalListeners();
            render();
        });
    </script>
</body>
</html>
